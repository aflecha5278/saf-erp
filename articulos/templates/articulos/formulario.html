{% extends "articulos/base.html" %}
{% load widget_tweaks %}

{% block title %}
{% if form.instance.pk %}Modificar artículo{% else %}Agregar artículo{% endif %} – Cianova 360
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="card shadow">
    <div class="card-header bg-marca text-dark fw-bold">
      {% if form.instance.pk %}Modificar artículo{% else %}Agregar artículo{% endif %}
    </div>
    <div class="card-body">
      <form method="post" id="articuloForm">
        {% csrf_token %}
		{% if form.errors %}
		  <div class="alert alert-danger border-start border-4 border-danger-subtle p-3">
			<strong>⚠️ Error al guardar el artículo:</strong>
			<ul class="mb-0">
			  {% for field in form %}
				{% for error in field.errors %}
				  <li><strong>{{ field.label }}:</strong> {{ error }}</li>
				{% endfor %}
			  {% endfor %}
			  {% for error in form.non_field_errors %}
				<li>{{ error }}</li>
			  {% endfor %}
			</ul>
		  </div>
		{% endif %}
        <div class="row mb-3">
          <div class="col-md-6">
		    {{ form.codart.label_tag }} 
			{% if codart_auto %}
				{% render_field form.codart readonly="readonly" class="form-control readonly-codart" %}
			{% else %}
				{% render_field form.codart class="form-control" %}
			{% endif %}
		  </div>
          <div class="col-md-6">
            {{ form.deposito.label_tag }} {{ form.deposito }}
          </div>
        </div>

        <div class="mb-3">
          {{ form.descrip.label_tag }} {{ form.descrip }}
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            {{ form.marca.label_tag }} {{ form.marca }}
          </div>
          <div class="col-md-6">
            {{ form.marca_nueva.label_tag }} {{ form.marca_nueva }}
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            {{ form.rubro.label_tag }} {{ form.rubro }}
          </div>
          <div class="col-md-6">
            {{ form.rubro_nueva.label_tag }} {{ form.rubro_nueva }}
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            {{ form.subrubro.label_tag }} {{ form.subrubro }}
          </div>
          <div class="col-md-6">
            {{ form.subrubro_nueva.label_tag }} {{ form.subrubro_nueva }}
          </div>
        </div>

        <!-- ✅ TABS -->
        <ul class="nav nav-tabs mt-4" id="articuloTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="page1-tab" data-bs-toggle="tab" data-bs-target="#page1" type="button" role="tab">Al público</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="page2-tab" data-bs-toggle="tab" data-bs-target="#page2" type="button" role="tab">Moneda extranj.</button>
          </li>
        </ul>

        <div class="tab-content border border-top-0 p-3" id="articuloTabsContent">
          <div class="tab-pane fade show active" id="page1" role="tabpanel">
            {% include "articulos/_form_precio.html" %}
          </div>
          <div class="tab-pane fade" id="page2" role="tabpanel">
            <p>Aquí van los campos de la página 2 (otros datos del artículo)</p>
          </div>
        </div>

        <!-- ✅ BOTONES -->
        <div class="d-flex justify-content-end gap-2 mt-4">
          <button type="submit" class="btn-aceptar">
            <i class="bi bi-check-circle"></i> Guardar
          </button>
          <a href="{% url 'lista_articulos' %}" class="btn-cancelar">
            <i class="bi bi-arrow-left-circle"></i> Volver a la lista
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modoCalculo   = document.querySelector('#id_modo_calculo');
    const precostoInput = document.querySelector('#id_precosto');
    const margenInput   = document.querySelector('#id_margen');
    const ncodalicSelect= document.querySelector('#id_ncodalic');
    const prefinalInput = document.querySelector('#prefinal-input');
    const prefinalDisplay = document.querySelector('#prefinal-display');
    const costoivaSpan  = document.querySelector('#costoiva');
    const preventaSpan  = document.querySelector('#preventa');
    const form          = document.querySelector('#articuloForm');

    let debounceTimeout;

    function calculateValues() {
        const precosto = parseFloat(precostoInput?.value) || 0;
        const margen   = parseFloat(margenInput?.value) || 0;

        const selectedOption = ncodalicSelect?.options[ncodalicSelect.selectedIndex];
        const alicMatch = selectedOption ? selectedOption.textContent.match(/\((\d+\.?\d*)%\)/) : null;
        const alic = alicMatch ? parseFloat(alicMatch[1]) || 0 : 0;

        const modo = modoCalculo?.value || 'C';

        // Costo con IVA
        const costoiva = precosto * (1 + alic / 100);
        if (costoivaSpan) costoivaSpan.textContent = (Math.round(costoiva * 100) / 100).toFixed(2);

        // Precio venta sin IVA
        const preventa = precosto * (1 + margen / 100);
        if (preventaSpan) preventaSpan.textContent = (Math.round(preventa * 100) / 100).toFixed(2);

        if (modo === 'C') {
            // Costo → Final
            const prefinal = preventa * (1 + alic / 100);
            const roundedPrefinal = Math.round(prefinal * 100) / 100;
            if (prefinalDisplay) prefinalDisplay.textContent = roundedPrefinal.toFixed(2);
            if (prefinalInput) {
                prefinalInput.value = roundedPrefinal.toFixed(2);
                prefinalInput.style.display = 'none';
            }
            if (prefinalDisplay) prefinalDisplay.style.display = 'inline';
        } else {
            // Final → Costo
            let prefinal = parseFloat(prefinalInput?.value) || 0;
            if (!isNaN(prefinal)) {
                const calculatedPreventa = prefinal / (1 + alic / 100);
                if (preventaSpan) preventaSpan.textContent = (Math.round(calculatedPreventa * 100) / 100).toFixed(2);

                const calculatedPrecosto = calculatedPreventa / (1 + margen / 100);
                if (precostoInput) precostoInput.value = (Math.round(calculatedPrecosto * 100) / 100).toFixed(2);
            }
            if (prefinalInput) prefinalInput.style.display = 'inline';
            if (prefinalDisplay) prefinalDisplay.style.display = 'none';
        }
    }

    // Función de debounce
    function debounce(func, delay) {
        return function (...args) {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Conectar todos los inputs/selects
    [precostoInput, margenInput, ncodalicSelect, prefinalInput, modoCalculo].forEach(element => {
        if (element) {
            element.addEventListener('input', debounce(calculateValues, 300));
            element.addEventListener('change', calculateValues);
        }
    });

    // Recalcular al inicio
    calculateValues();

    // Antes de enviar, normalizar a 2 decimales
    if (form) {
        form.addEventListener('submit', function(e) {
            if (precostoInput && precostoInput.value) {
                precostoInput.value = (Math.round(parseFloat(precostoInput.value) * 100) / 100).toFixed(2);
            }
            if (margenInput && margenInput.value) {
                margenInput.value = (Math.round(parseFloat(margenInput.value) * 100) / 100).toFixed(2);
            }
            if (prefinalInput && prefinalInput.value) {
                let prefinal = parseFloat(prefinalInput.value.replace(",", "."));
                prefinalInput.value = (Math.round(prefinal * 100) / 100).toFixed(2);
            }
        });
    }
});
</script>

{% endblock %}
