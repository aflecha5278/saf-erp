{% extends "base.html" %}
{% load widget_tweaks %}
{% block title %}
{% if form.instance.pk %}Modificar artículo{% else %}Agregar artículo{% endif %} – Cianova 
{% endblock %}
{% block content %}
<div class="container my-4">
  <div class="card shadow">
    <div class="card-header bg-marca text-dark fw-bold">
      {% if form.instance.pk %}Modificar artículo{% else %}Agregar artículo{% endif %}
    </div>
    <div class="card-body">
		{% if messages %}
			{% for message in messages %}
				<div class="alert alert-danger">
				{{ message }}
				</div>
			{% endfor %}
		{% endif %}
	  <form method="post" id="articuloForm">
	    {% csrf_token %}
		{% if form.errors %}
		  <div class="alert alert-danger border-start border-4 border-danger-subtle p-3">
			<strong>⚠️ Error al guardar el artículo:</strong>
			<ul class="mb-0">
			  {% for field in form %}
				{% for error in field.errors %}
				  <li><strong>{{ field.label }}:</strong> {{ error }}</li>
				{% endfor %}
			  {% endfor %}
			  {% for error in form.non_field_errors %}
				<li>{{ error }}</li>
			  {% endfor %}
			</ul>
		  </div>
		{% endif %}
        <div class="row mb-3">
          <div class="col-md-3">
		    {{ form.codart.label_tag }} 
			{% if codart_auto %}
				{% render_field form.codart readonly="readonly" class="form-control readonly-codart" %}
			{% else %}
				{% render_field form.codart class="form-control" %}
			{% endif %}
		  </div>
          <div class="col-md-3">
            {{ form.deposito.label_tag }} {{ form.deposito }}
          </div>
        </div>

        <div class="mb-3">
          {{ form.descrip.label_tag }} {{ form.descrip }}
        </div>

        <div class="row mb-3">
			<div class="col-md-3">
				{{ form.marca.label_tag }}
				{% render_field form.marca class="form-select input-cianova w-100" %}
			</div>
			<div class="col-md-3">
				{{ form.marca_nueva.label_tag }}
				{% render_field form.marca_nueva class="form-control input-cianova w-100" %}
			</div>
			<div class="col-md-3">
				{{ form.rubro.label_tag }}
				{% render_field form.rubro class="form-select input-cianova w-100" %}
			</div>
			<div class="col-md-3">
				{{ form.rubro_nueva.label_tag }}
				{% render_field form.rubro_nueva class="form-control input-cianova w-100" %}
			</div>
		</div>

		<div class="row mb-3">
			<div class="col-md-3">
				{{ form.subrubro.label_tag }}
				{% render_field form.subrubro class="form-select input-cianova w-100" %}
			</div>
			<div class="col-md-3">
				{{ form.subrubro_nueva.label_tag }}
				{% render_field form.subrubro_nueva class="form-control input-cianova w-100" %}
			</div>
		</div>

		<!-- ✅ TABS -->
        <ul class="nav nav-tabs mt-4" id="articuloTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="page1-tab" data-bs-toggle="tab" data-bs-target="#page1" type="button" role="tab">Al público</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="page2-tab" data-bs-toggle="tab" data-bs-target="#page2" type="button" role="tab">Moneda extranj.</button>
          </li>
	    </ul>

        <div class="tab-content border border-top-0 p-3" id="articuloTabsContent">
          <div class="tab-pane fade show active" id="page1" role="tabpanel">
			{% include "articulos/_form_precio.html" %}
          </div>
          <div class="tab-pane fade" id="page2" role="tabpanel">
			{% include "monedas/form_moneda_ext.html" %}
		  </div>
        </div>
		
		<div class="row mb-3">
		  <div class="col-md-3">
			{{ form.cantidad.label_tag }}
			{{ form.cantidad|add_class:"form-control input-cianova w-100"|attr:"step:0.0001" }}
		  </div>
		  <div class="col-md-3">
			{{ form.unimed.label_tag }}
			{{ form.unimed|add_class:"form-select input-cianova w-100" }}
		  </div>
		  <div class="col-md-3">
			{{ form.codprovee.label_tag }}
			{% render_field form.codprovee class="form-select input-cianova w-100" %}
		  </div>
		  <div class="col-md-3">
			{{ form.bajostock.label_tag }}	
			{{ form.bajostock|add_class:"form-control input-cianova w-100"|attr:"step:0.0001" }}
		  </div>			
		</div>
		
		<div class="row mb-3">
			<div class="col-md-3">
				{{ form.ubicacion.label_tag }}
				{% render_field form.ubicacion class="form-select input-cianova w-100" %}
			</div>
		</div>
		
		<div class="form-group">
			{{ form.obs.label_tag }}
			{% render_field form.obs class="form-control input-cianova w-100" rows="4" placeholder="Notas internas, advertencias, detalles técnicos..." %}
		</div>
		
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="grupo-opciones">
					<label class="grupo-label">Artículo activo:</label>
					{{ form.activo }}
				</div>
			</div>	
			<div class="col-md-3">
				{% if form.prodela %}
					<div class="form-group">
						{{ form.prodela.label_tag }}
						{% render_field form.prodela class="combo-neutral" %}
					</div>
				{% endif %}
			</div>
			<div class="col-md-3">
				{% if form.tipopeso %}
					<div class="form-group">
						{{ form.tipopeso.label_tag }}
						{% render_field form.tipopeso class="combo-neutral" %}
					</div>
				{% endif %}
			</div>	
		</div>
		<!------------->
		<!-- BOTONES -->
		<!------------->
        <div class="d-flex justify-content-end gap-2 mt-4">
			<button type="submit" class="btn-aceptar">
				<i class="bi bi-check-circle"></i> Guardar
			</button>
			 <a href="{% url 'lista_articulos' %}" class="btn-cancelar">
				<i class="bi bi-arrow-left-circle"></i> Volver a la lista
			</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const precostoInput     = document.querySelector('#id_precosto');
    const margenInput       = document.querySelector('#id_margen');
    const ncodalicSelect    = document.querySelector('#id_ncodalic');
    const prefinalInput     = document.querySelector('#prefinal-input');
    const prefinalDisplay   = document.querySelector('#prefinal-display');
    const costoivaInput     = document.querySelector('#costoiva');
    const preventaInput     = document.querySelector('#preventa');
    const modoCalculo       = document.querySelector('#id_modo_calculo');
    const ctomeInput        = document.querySelector('input[name="ctome"]');
    const cotizInput        = document.querySelector('input[name="cotiz"]');
    const form              = document.querySelector('#articuloForm');

    let debounceTimeout;

    function getAlicuota() {
        const selectedOption = ncodalicSelect?.options[ncodalicSelect.selectedIndex];
        const match = selectedOption?.textContent.match(/\((\d+\.?\d*)%\)/);
        const alic = match ? parseFloat(match[1]) : 0;
        return alic < 1 ? alic * 100 : alic;
    }

    function calcularDesdeCosto(costo) {
        const margen = parseFloat(margenInput?.value) || 0;
        const alic = getAlicuota();

        const preventa = costo * (1 + margen / 100);
        const prefinal = preventa * (1 + alic / 100);
        const costoiva = costo * (1 + alic / 100);

        return { preventa, prefinal, costoiva };
    }

    function actualizarCampos(costo) {
        const modo = ['C', 'F'].includes(modoCalculo?.value) ? modoCalculo.value : 'C';
        const { preventa, prefinal, costoiva } = calcularDesdeCosto(costo);

        if (modo === 'C') {
            preventaInput.value = preventa.toFixed(2);
            prefinalInput.value = prefinal.toFixed(2);
            prefinalDisplay.textContent = prefinal.toFixed(2);
            prefinalInput.style.display = 'none';
            prefinalDisplay.style.display = 'inline';
        } else {
            const prefinalManual = parseFloat(prefinalInput?.value) || 0;
            const alic = getAlicuota();
            const preventaCalc = prefinalManual / (1 + alic / 100);
            const margen = parseFloat(margenInput?.value) || 0;
            const precostoCalc = preventaCalc / (1 + margen / 100);

            preventaInput.value = preventaCalc.toFixed(2);
            precostoInput.value = precostoCalc.toFixed(2);
            prefinalInput.style.display = 'inline';
            prefinalDisplay.style.display = 'none';
        }

        if (costoivaInput) costoivaInput.value = costoiva.toFixed(2);
    }

    function calcularDesdeME() {
        const costoME = parseFloat(ctomeInput?.value) || 0;
        const cotiz = parseFloat(cotizInput?.value) || 0;
        const costoLocal = costoME * cotiz;

        if (precostoInput) {
            precostoInput.value = costoLocal.toFixed(2);
            precostoInput.dispatchEvent(new Event('input', { bubbles: true }));
        }

        actualizarCampos(costoLocal);
    }

    function debounce(func, delay) {
        return function (...args) {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Disparadores
    [precostoInput, margenInput, ncodalicSelect, prefinalInput, modoCalculo].forEach(el => {
        el?.addEventListener('input', debounce(() => {
            const costo = parseFloat(precostoInput?.value) || 0;
            actualizarCampos(costo);
        }, 300));
        el?.addEventListener('change', () => {
            const costo = parseFloat(precostoInput?.value) || 0;
            actualizarCampos(costo);
        });
    });

    ctomeInput?.addEventListener('input', debounce(calcularDesdeME, 300));
    cotizInput?.addEventListener('input', debounce(calcularDesdeME, 300));

    // Inicial
    const costoInicial = parseFloat(precostoInput?.value) || 0;
    actualizarCampos(costoInicial);

    // Normalización antes de enviar
    form?.addEventListener('submit', function () {
        [precostoInput, margenInput, prefinalInput].forEach(input => {
            if (input && input.value) {
                input.value = (Math.round(parseFloat(input.value.replace(",", ".")) * 100) / 100).toFixed(2);
            }
        });
        prefinalInput.style.display = 'inline';
    });
});
</script>
{% endblock %}


