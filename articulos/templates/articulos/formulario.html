{% extends "articulos/base.html" %}
{% load widget_tweaks %}

{% block title %}
{% if form.instance.pk %}Modificar art√≠culo{% else %}Agregar art√≠culo{% endif %} - SAF ERP
{% endblock %}

{% block content %}
<div class="list-container">
    <div class="list-card">
        <h1>{% if form.instance.pk %}Modificar art√≠culo{% else %}Agregar art√≠culo{% endif %}</h1>

        {% if form.errors %}
            <div class="error-message">
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        {{ field|title }}: {{ error }}<br>
                    {% endfor %}
                {% endfor %}
            </div>
        {% endif %}

        <!-- ‚úÖ FORMULARIO √öNICO -->
        <form method="post" id="articuloForm">
            {% csrf_token %}

            <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                {{ form.codart.label_tag }} {{ form.codart }}
                {{ form.deposito.label_tag }} {{ form.deposito }}
            </div>
            <div class="form-group">
                {{ form.descrip.label_tag }} {{ form.descrip }}
            </div>
            <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                {{ form.marca.label_tag }} {{ form.marca }} √≥
                {{ form.marca_nueva.label_tag }} {{ form.marca_nueva }}
            </div>
            <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                {{ form.rubro.label_tag }} {{ form.rubro }} √≥
                {{ form.rubro_nueva.label_tag }} {{ form.rubro_nueva }}
            </div>
            <div class="form-group" style="display:flex; align-items:center; gap:10px;">
                {{ form.subrubro.label_tag }} {{ form.subrubro }} √≥
                {{ form.subrubro_nueva.label_tag }} {{ form.subrubro_nueva }}
            </div>

            <!-- ‚úÖ TABS -->
            <div class="container mt-4">
                <ul class="nav nav-tabs" id="articuloTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="page1-tab" data-bs-toggle="tab" data-bs-target="#page1" type="button" role="tab">Al p√∫blico</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="page2-tab" data-bs-toggle="tab" data-bs-target="#page2" type="button" role="tab">Moneda extranj.</button>
                    </li>
                </ul>

                <div class="tab-content" id="articuloTabsContent">
                    <div class="tab-pane fade show active p-3" id="page1" role="tabpanel">
                        {% include "articulos/_form_precio.html" %}
                    </div>
                    <div class="tab-pane fade p-3" id="page2" role="tabpanel">
                        <p>Aqu√≠ van los campos de la p√°gina 2 (otros datos del art√≠culo)</p>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ BOTONES -->
            <div class="actions mt-3">
                <button type="submit" class="btn btn-primary">Guardar</button>
                <button type="button" class="btn btn-danger" onclick="window.location.href='{% url 'lista_articulos' %}'">
                    Volver a la lista
                </button>
            </div>
        </form>
        <!-- üö´ YA NO HAY FORM ANIDADO -->
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modoCalculo   = document.querySelector('#id_modo_calculo');
    const precostoInput = document.querySelector('#id_precosto');
    const margenInput   = document.querySelector('#id_margen');
    const ncodalicSelect= document.querySelector('#id_ncodalic');
    const prefinalInput = document.querySelector('#prefinal-input');
    const prefinalDisplay = document.querySelector('#prefinal-display');
    const costoivaSpan  = document.querySelector('#costoiva');
    const preventaSpan  = document.querySelector('#preventa');
    const form          = document.querySelector('#articuloForm');

    let debounceTimeout;

    function calculateValues() {
        const precosto = parseFloat(precostoInput?.value) || 0;
        const margen   = parseFloat(margenInput?.value) || 0;

        const selectedOption = ncodalicSelect?.options[ncodalicSelect.selectedIndex];
        const alicMatch = selectedOption ? selectedOption.textContent.match(/\((\d+\.?\d*)%\)/) : null;
        const alic = alicMatch ? parseFloat(alicMatch[1]) || 0 : 0;

        const modo = modoCalculo?.value || 'C';

        // Costo con IVA
        const costoiva = precosto * (1 + alic / 100);
        if (costoivaSpan) costoivaSpan.textContent = (Math.round(costoiva * 100) / 100).toFixed(2);

        // Precio venta sin IVA
        const preventa = precosto * (1 + margen / 100);
        if (preventaSpan) preventaSpan.textContent = (Math.round(preventa * 100) / 100).toFixed(2);

        if (modo === 'C') {
            // Costo ‚Üí Final
            const prefinal = preventa * (1 + alic / 100);
            const roundedPrefinal = Math.round(prefinal * 100) / 100;
            if (prefinalDisplay) prefinalDisplay.textContent = roundedPrefinal.toFixed(2);
            if (prefinalInput) {
                prefinalInput.value = roundedPrefinal.toFixed(2);
                prefinalInput.style.display = 'none';
            }
            if (prefinalDisplay) prefinalDisplay.style.display = 'inline';
        } else {
            // Final ‚Üí Costo
            let prefinal = parseFloat(prefinalInput?.value) || 0;
            if (!isNaN(prefinal)) {
                const calculatedPreventa = prefinal / (1 + alic / 100);
                if (preventaSpan) preventaSpan.textContent = (Math.round(calculatedPreventa * 100) / 100).toFixed(2);

                const calculatedPrecosto = calculatedPreventa / (1 + margen / 100);
                if (precostoInput) precostoInput.value = (Math.round(calculatedPrecosto * 100) / 100).toFixed(2);
            }
            if (prefinalInput) prefinalInput.style.display = 'inline';
            if (prefinalDisplay) prefinalDisplay.style.display = 'none';
        }
    }

    // Funci√≥n de debounce
    function debounce(func, delay) {
        return function (...args) {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Conectar todos los inputs/selects
    [precostoInput, margenInput, ncodalicSelect, prefinalInput, modoCalculo].forEach(element => {
        if (element) {
            element.addEventListener('input', debounce(calculateValues, 300));
            element.addEventListener('change', calculateValues);
        }
    });

    // Recalcular al inicio
    calculateValues();

    // Antes de enviar, normalizar a 2 decimales
    if (form) {
        form.addEventListener('submit', function(e) {
            if (precostoInput && precostoInput.value) {
                precostoInput.value = (Math.round(parseFloat(precostoInput.value) * 100) / 100).toFixed(2);
            }
            if (margenInput && margenInput.value) {
                margenInput.value = (Math.round(parseFloat(margenInput.value) * 100) / 100).toFixed(2);
            }
            if (prefinalInput && prefinalInput.value) {
                let prefinal = parseFloat(prefinalInput.value.replace(",", "."));
                prefinalInput.value = (Math.round(prefinal * 100) / 100).toFixed(2);
            }
        });
    }
});
</script>

{% endblock %}
