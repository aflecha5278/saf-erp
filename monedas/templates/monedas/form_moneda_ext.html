{% load widget_tweaks l10n %}
<div class="form-card">
    <div class="container-fluid">
		<div class="row g-3">
			<div class="col-md-3">
			    <label for="codmoneda" class="form-label">Moneda:</label>
				<select name="codmoneda" id="codmoneda" class="form-select input-cianova-sm">
					{% for m in monedas %}
					<option value="{{ m.codmoneda }}"
						data-cotiz="{{ m.cotiz|default:"0"|unlocalize }}"
						{% if form.initial.codmoneda == m.codmoneda %}selected{% endif %}>
						{{ m.codmoneda }} – {{ m.descrip }}
					</option>
					{% endfor %}
				</select>
			</div>	
			
			<!-- Cotización -->
			<div class="col-md-3">
			  <label for="cotiz" class="form-label">Cotización:</label>
			  <input type="text" name="cotiz" id="cotiz" class="form-control input-cianova-sm" value="{{ form.instance.cotiz|default_if_none:"0"|floatformat:5 }}" readonly>
			</div>

			<!-- Costo M.Ext. -->
			<div class="col-md-3">
			  {{ form.ctome.label_tag }}
			  {{ form.ctome|add_class:"form-control input-cianova-sm" }}
			</div>

			<!-- Venta M.Ext. -->
			<div class="col-md-3">
			  {{ form.vtame.label_tag }}
			  {{ form.vtame|add_class:"form-control input-cianova-sm" }}
			</div>

			<!-- Final M.Ext. -->
			<div class="col-md-3">
			  {{ form.finme.label_tag }}
			  {{ form.finme|add_class:"form-control input-cianova-sm" }}
			</div>
		</div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const monedaSelect = document.getElementById('codmoneda');
  const cotizInput   = document.querySelector('input[name="cotiz"]');

  function actualizarCotizacion() {
    const selected = monedaSelect?.options[monedaSelect.selectedIndex];
    const cotiz = parseFloat(selected?.dataset.cotiz) || 0;
    if (cotizInput) cotizInput.value = cotiz.toFixed(5);
  }

  monedaSelect?.addEventListener('change', actualizarCotizacion);

  // Inicializar cotización al cargar
  actualizarCotizacion();
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const ctomeInput   = document.querySelector('input[name="ctome"]');
  const vtameInput   = document.querySelector('input[name="vtame"]');
  const finmeInput   = document.querySelector('input[name="finme"]');
  const margenHidden = document.getElementById('margen-hidden');
  const alicHidden   = document.getElementById('alic-hidden');

  function calcularDesdeCostoME() {
    const ctome = parseFloat(ctomeInput?.value) || 0;
    const margen = parseFloat(margenHidden?.value) || 0;
    const alic = parseFloat(alicHidden?.value) || 0;

    const ventaME = ctome * (1 + margen / 100);
    const finalME = ventaME * (1 + alic / 100);

    if (vtameInput) vtameInput.value = ventaME.toFixed(2);
    if (finmeInput) finmeInput.value = finalME.toFixed(2);
  }

  ctomeInput?.addEventListener('input', calcularDesdeCostoME);
  calcularDesdeCostoME(); // inicializa si hay valor precargado
});
</script>





